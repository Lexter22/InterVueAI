<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Interview Summary - IntervueAI</title>
  <link rel="stylesheet" href="/css/styles.css" />
</head>
<body>
  <header class="nav">
    <div class="nav-inner">
      <div class="nav-left">
        <div class="logo-badge">A</div>
        <div>
          <div class="nav-title">IntervueAI</div>
          <div class="nav-sub">AI Interview Summary</div>
        </div>
      </div>
    </div>
  </header>

  <main class="shell summary-shell">
    <div class="card summary-card">
      <h1 class="summary-title">Interview Summary</h1>
      <div class="position-info">
        <p><strong>Position:</strong> <span id="positionName">Loading...</span></p>
        <p><strong>Overall Score:</strong> <span id="overallScore">--</span>%</p>
      </div>

      <!-- Scorecard Grid -->
      <div class="scorecard-grid" id="scorecardGrid">
        <!-- Dynamic content will be loaded here -->
      </div>

      <!-- AI Feedback -->
      <div class="card feedback-card">
        <h3 class="feedback-title">AI Feedback</h3>
        <p class="feedback-text" id="aiFeedback">
          Loading feedback...
        </p>
      </div>

      <!-- Final Verdict -->
      <div class="verdict-card">
        <h2 class="verdict-title">Final Result: <strong id="finalResult">Processing...</strong></h2>
        <p class="verdict-subtitle" id="recommendation">Please wait while we process your results.</p>
      </div>

      <!-- Buttons -->
      <div class="summary-actions">
        <a href="/" class="btn btn-ghost summary-btn">Return to Home</a>
      </div>
    </div>
  </main>

  <script>
    // Load and display interview results
    document.addEventListener('DOMContentLoaded', async function() {
      const results = JSON.parse(localStorage.getItem('interviewResults') || '{}');
      
      if (Object.keys(results).length === 0) {
        // Try to load from database if available
        const interviewData = JSON.parse(localStorage.getItem('interviewData') || '{}');
        if (interviewData.applicant_id) {
          await loadResultsFromDatabase(interviewData.applicant_id);
        } else {
          // Fallback to mock data if no results found
          displayMockResults();
        }
        return;
      }
      
      displayResults(results);
    });

    async function loadResultsFromDatabase(applicant_id) {
      try {
        const response = await fetch(`/api/hr/applicants`);
        if (response.ok) {
          const data = await response.json();
          const applicant = data.data.find(a => a.applicant_id === applicant_id);
          
          if (applicant && applicant.score_overall !== null) {
            // Convert database results to our format
            const dbResults = {
              position: applicant.job_title,
              overall_score: applicant.score_overall,
              category_scores: [
                { category: 'Technical Skills', status: applicant.score_overall >= 70 ? 'Passed' : 'Failed' },
                { category: 'Communication', status: applicant.eye_contact_score >= 70 ? 'Passed' : 'Failed' }
              ],
              ai_feedback: applicant.summary_text || 'Interview completed successfully.',
              overall_result: applicant.score_overall >= 60 ? 'PASS' : 'FAIL',
              recommendation: applicant.improvement_tips || 'Thank you for completing the interview.'
            };
            displayResults(dbResults);
            return;
          }
        }
      } catch (error) {
        console.error('Failed to load results from database:', error);
      }
      
      // Fallback to mock data
      displayMockResults();
    }

    function displayResults(results) {
      // Update position and overall score
      document.getElementById('positionName').textContent = results.position || 'Unknown Position';
      document.getElementById('overallScore').textContent = results.overall_score || 0;
      
      // Update scorecard grid
      const grid = document.getElementById('scorecardGrid');
      grid.innerHTML = '';
      
      if (results.category_scores && results.category_scores.length > 0) {
        // Group categories into pairs for grid layout
        for (let i = 0; i < results.category_scores.length; i += 2) {
          const card = document.createElement('div');
          card.className = 'card scorecard-item';
          
          const cat1 = results.category_scores[i];
          const cat2 = results.category_scores[i + 1];
          
          card.innerHTML = `
            <p><strong>${cat1.category}:</strong> <span class="score-${cat1.status.toLowerCase()}">${cat1.status}</span></p>
            ${cat2 ? `<p><strong>${cat2.category}:</strong> <span class="score-${cat2.status.toLowerCase()}">${cat2.status}</span></p>` : ''}
          `;
          
          grid.appendChild(card);
        }
      }
      
      // Update AI feedback
      document.getElementById('aiFeedback').innerHTML = results.ai_feedback || 'No feedback available.';
      
      // Update final result
      const resultElement = document.getElementById('finalResult');
      const recommendationElement = document.getElementById('recommendation');
      
      resultElement.textContent = results.overall_result === 'PASS' ? 'PASS' : 'NEEDS IMPROVEMENT';
      recommendationElement.textContent = results.recommendation || 'Thank you for completing the interview.';
      
      // Update result styling
      resultElement.className = results.overall_result === 'PASS' ? 'result-pass' : 'result-fail';
    }

    function displayMockResults() {
      const mockResults = {
        position: 'Software Developer',
        overall_score: 75,
        category_scores: [
          { category: 'Experience', status: 'Passed' },
          { category: 'Background', status: 'Passed' },
          { category: 'Frameworks', status: 'Failed' },
          { category: 'Skills', status: 'Passed' }
        ],
        ai_feedback: 'You demonstrated <strong>solid technical knowledge</strong> and good communication skills. Areas for improvement include <strong>framework-specific knowledge</strong>.',
        overall_result: 'PASS',
        recommendation: 'You have been forwarded to the HR team for final interview.'
      };
      
      displayResults(mockResults);
    }
  </script>

  <style>
    .position-info {
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .position-info p {
      margin: 5px 0;
      font-size: 16px;
    }
    
    .score-passed {
      color: #28a745;
      font-weight: bold;
    }
    
    .score-failed {
      color: #dc3545;
      font-weight: bold;
    }
    
    .result-pass {
      color: #28a745;
    }
    
    .result-fail {
      color: #dc3545;
    }
  </style>
</body>
</html>