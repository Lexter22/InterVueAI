<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IntervueAI - Apply Now</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <!-- NAVBAR -->
    <header class="nav">
      <div class="nav-inner">
        <div class="nav-left">
          <div class="logo-badge">A</div>
          <div>
            <div class="nav-title">IntervueAI</div>
            <div class="nav-sub">
              AI Voice Pre-Screening · Powered by Agora + AWS
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="shell">
      <!-- HERO -->
      <section class="hero">
        <div class="hero-text">
          <h1>
            Build your <span>AI HR Interviewer</span><br />with Agora real-time
            voice.
          </h1>
          <p>
            This demo portal automates the first-round HR screening using an AI
            voice agent over Agora RTC.
          </p>
          <div class="hero-chips">
            <div class="chip">B2B hiring automation</div>
            <div class="chip">Agora RTC · RTM</div>
            <div class="chip">AWS + JSON storage</div>
            <div class="chip">Data privacy aware</div>
          </div>
          <div class="hero-badges">
            <span>AI Voice Agent online</span>
            <span>Pre-screening time saved: ~60%</span>
          </div>
        </div>
        <div class="hero-panel">
          <div class="hero-panel-header">
            <span>AI Interview Call Preview</span>
            <span class="status-pill">Real-time · AgoraRTC</span>
          </div>
          <div class="fake-call">
            <div class="fake-avatar">AI</div>
            <div class="fake-call-main">
              <div class="title">AI Recruiter · Voice</div>
              <div class="subtitle">
                "Tell me about your most recent role and key responsibilities."
              </div>
              <div class="fake-call-badges">
                <span>STT + LLM Scoring</span>
                <span>HR rubric based</span>
                <span>Pass / Fail only</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- APPLICANT LAYOUT -->
      <section class="applicant-layout">
        <!-- JOB LIST WITH SEARCH -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Open Positions</div>
            <div class="card-subtitle">
              Search and choose a role to start your AI pre-interview.
            </div>
          </div>

          <!-- SEARCH BOX -->
          <div class="search-box">
            <input
              type="text"
              id="jobSearchInput"
              class="search-input"
              placeholder="Search by job title, department, or keywords..."
            />
            <svg
              class="search-icon"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="11" cy="11" r="8" />
              <path d="m21 21-4.35-4.35" />
            </svg>
          </div>

          <!-- JOB LIST -->
          <div class="job-list" id="jobList">
            <!-- Jobs will be loaded dynamically -->
          </div>

          <!-- NO RESULTS MESSAGE -->
          <div id="noResultsMessage" class="no-results" style="display: none">
            <svg
              width="48"
              height="48"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="11" cy="11" r="8" />
              <path d="m21 21-4.35-4.35" />
              <line x1="8" y1="11" x2="14" y2="11" />
            </svg>
            <div><strong>No jobs found</strong></div>
            <div style="margin-top: 6px; font-size: 12px">
              Try adjusting your search terms
            </div>
          </div>
        </div>

        <!-- APPLICATION FORM -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Application Form</div>
            <div class="card-subtitle">
              Selected role: <span id="selected-role-label">None</span>
            </div>
          </div>
          <form id="applicationForm">
            <input type="hidden" id="job_id" value="" />
            <div class="form-group">
              <label for="full_name">Full name</label>
              <input
                id="full_name"
                type="text"
                required
                placeholder="Enter your full name"
              />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="email">Email</label>
                <input
                  id="email"
                  type="email"
                  required
                  placeholder="Enter your email"
                />
              </div>
              <div class="form-group">
                <label for="mobile_number">Mobile number</label>
                <input
                  id="mobile_number"
                  type="tel"
                  required
                  placeholder="Enter your mobile number"
                />
              </div>
            </div>

            <div class="form-group">
              <div class="inline-group">
                <input type="checkbox" id="consent" required />
                <label for="consent"
                  >I agree to data privacy terms and AI screening</label
                >
              </div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn btn-ghost" id="clearBtn">
                Clear form
              </button>
              <button type="submit" class="btn btn-primary">
                Start Interview
              </button>
            </div>
            <div id="statusBanner" class="status-banner">
              <span id="statusMessage"></span>
            </div>
          </form>
        </div>
      </section>
    </main>

    <!-- Temporary Buttons -->
    <div style="position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px;">
      <button onclick="testDatabase()" class="btn btn-ghost" style="padding: 8px 12px; border-radius: 50px; font-size: 11px;">
        Test DB
      </button>
      <button onclick="window.location.href='hr-dashboard.html'" class="btn btn-primary" style="padding: 10px 16px; border-radius: 50px; box-shadow: 0 4px 12px rgba(56, 189, 248, 0.3);">
        HR Dashboard
      </button>
    </div>



    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const selectedRoleLabel = document.getElementById("selected-role-label");
        const statusBanner = document.getElementById("statusBanner");
        const form = document.getElementById("applicationForm");
        const clearBtn = document.getElementById("clearBtn");

        // Load jobs from API
        loadJobs();

        async function loadJobs() {
            try {
                console.log('Loading jobs...');
                const response = await fetch('/api/jobs');
                const result = await response.json();
                console.log('Jobs response:', result);
                
                if (result.success) {
                    console.log('Displaying jobs:', result.data);
                    displayJobs(result.data);
                } else {
                    console.error('Failed to load jobs:', result.error);
                }
            } catch (error) {
                console.error('Error loading jobs:', error);
            }
        }

        function displayJobs(jobs) {
            console.log('displayJobs called with:', jobs);
            const jobList = document.getElementById('jobList');
            
            if (!jobList) {
                console.error('jobList element not found!');
                return;
            }
            
            jobList.innerHTML = '';
            
            if (!jobs || jobs.length === 0) {
                jobList.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 20px;">No open positions available</p>';
                return;
            }
            
            jobs.forEach(job => {
                console.log('Creating job card for:', job.title);
                const jobCard = document.createElement('div');
                jobCard.className = 'job-card';
                jobCard.dataset.jobId = job.job_id;
                jobCard.innerHTML = `
                    <div class="job-title">${job.title}</div>
                    <div class="job-meta">${job.job_requirements ? job.job_requirements.substring(0, 100) + '...' : 'No description available'}</div>
                    <div class="job-tags">
                        <span class="job-tag">${job.status}</span>
                    </div>
                `;
                
                jobCard.addEventListener('click', () => {
                    selectedRoleLabel.textContent = job.title;
                    document.getElementById('job_id').value = job.job_id;
                    
                    document.querySelectorAll('.job-card').forEach(c => c.style.borderColor = 'var(--border)');
                    jobCard.style.borderColor = 'rgba(56, 189, 248, 0.6)';
                });
                
                jobList.appendChild(jobCard);
            });
            
            console.log('Jobs displayed successfully');
        }

        // Clear form
        clearBtn.addEventListener('click', () => {
            form.reset();
            selectedRoleLabel.textContent = 'None';
            document.getElementById('job_id').value = '';
            document.querySelectorAll('.job-card').forEach(c => c.style.borderColor = 'var(--border)');
            statusBanner.classList.remove('show');
        });

        // Form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const jobId = document.getElementById('job_id').value;
            if (!jobId) {
                showStatus('Please select a job position first', 'error');
                return;
            }

            const formData = {
                job_id: parseInt(jobId),
                full_name: document.getElementById('full_name').value,
                email: document.getElementById('email').value,
                mobile_number: document.getElementById('mobile_number').value
            };
            
            try {
                showStatus('Submitting application...', 'info');
                
                const response = await fetch('/api/application/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus('Application submitted! Redirecting to interview...', 'success');
                    setTimeout(() => {
                        window.location.href = `/interview-room.html?token=${result.token}`;
                    }, 1500);
                } else {
                    showStatus('Error: ' + result.error, 'error');
                }
            } catch (error) {
                showStatus('Network error: ' + error.message, 'error');
            }
        });

        function showStatus(message, type) {
            const messageEl = document.getElementById('statusMessage');
            messageEl.textContent = message;
            statusBanner.className = `status-banner show status-${type === 'error' ? 'info' : type}`;
            
            if (type === 'success') {
                setTimeout(() => {
                    statusBanner.classList.remove('show');
                }, 3000);
            }
        }

      });

      // Test database connection (global function)
      async function testDatabase() {
          try {
              const response = await fetch('/api/test-db');
              const result = await response.json();
              
              if (result.success) {
                  alert('✅ Database connected successfully!');
              } else {
                  alert('❌ Database connection failed: ' + result.error);
              }
          } catch (error) {
              alert('❌ Network error: ' + error.message);
          }
      }
    </script>
  </body>
</html>
